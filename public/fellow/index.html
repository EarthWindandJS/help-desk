<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>HR Stream</title>
  	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
    <link rel="stylesheet" href="./css/styles.css" />
  </head>
  <body>
  	<h1 class="text-center">Help Request Status</h1>
    <div id="help-requests">
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.0/react-dom.js"></script>
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
    <script>console.log('babel loaded');</script>
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
   	<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.7/socket.io.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

    <script type="text/babel">

    	// 
    	var fellowInfo = {
    		name: 'Joe Nayigiziki'
    	};

   		var socket = io();
   		// socket listeners are found in componentWillMount
   		// of the parent-most Component

	    var DatabaseEntry = React.createClass({
	    	handleClick: function(e) {

	    		var databaseEntry = this.props.obj;
	    		_.extend(databaseEntry, fellowInfo);
	    		switch (this.props.status) {
	    			case 'outstanding':
	    				socket.emit('accept-hr', databaseEntry);
	    				break;
    				case 'in-progress':
    					socket.emit('close-hr', databaseEntry);
	    				break;
    				case 'closed':
    					alert('Why did you do that?!');
	    				break;
	    		}

	    		// this.props.parentClickHandler();
	    	},

	    	render: function() {
	    		var objectProps = [];
	    		for (var key in this.props.obj) {
	    			objectProps.push(<p>{key + ': ' + this.props.obj[key]}</p>);
	    		}
	    		return (
	    			<div className="db-entry" onClick={ this.handleClick }>
	    				<span>{ objectProps }</span>
	    			</div>
	  			);
	    	}
	    });

	    var DatabaseViewer = React.createClass({
	    	parentHandleClick: function(data) {
	    		// console.log('Fellow accepted HR');
	    		// this.getMongo();
	    	},
	    	getMongo: function() {
	    		$.get(this.props.source, function(data) {
		    		console.log('success: ' + JSON.stringify(data));
		    		if(this.isMounted()) {
		    			this.setState({
		    				helpRequests: [].concat(data)
		    			});
		    		}
		    	}.bind(this));
	    	},
	    	getInitialState: function() {
		    	return {
		    		helpRequests: []
		    	};
	    	},
	    	componentWillMount: function() {
					this.getMongo();
	    	},
	    	componentDidMount: function() {
					var socket = io();
					socket.on('fellow-closed', function(data) {
						console.log('fellow-closed: ' + JSON.stringify(data));
						this.getMongo();
					});
					socket.on('fellow-accepted', function(data) {
						console.log('fellow-accepted: ' + JSON.stringify(data));
						this.getMongo();
					}.bind(this));
				  socket.on('entry-deleted', function (data) {
				    console.log('entry-deleted: ' + JSON.stringify(data));
				    this.getMongo();
				  }.bind(this));
				  socket.on('entry-added', function(data) {
				  	console.log('entry-added: ' + JSON.stringify(data));
				    this.getMongo();
				  }.bind(this));
	    	},
	    	render: function() {
	    		var outstandingHRs = [];
	    		var inProgressHRs = [];
	    		var closedHRs = [];
	    		this.state.helpRequests.forEach(function(helpRequest, idx) {
	    			if (helpRequest.accepted && !helpRequest.closed) {
	    				console.log('adding entry: in-progress');
	    				inProgressHRs.push(<DatabaseEntry obj={ helpRequest } key={ idx } status="in-progress" parentClickHandler={ this.parentHandleClick } />);
	    			} else if (!helpRequest.accepted && !helpRequest.closed) {
	    				console.log('adding entry: oustanding');
	    				outstandingHRs.push(<DatabaseEntry obj={ helpRequest } key={ idx } status="outstanding" parentClickHandler={ this.parentHandleClick } />);
	    			} else {
	    				console.log('adding entry: closed');
	    				closedHRs.push(<DatabaseEntry obj={ helpRequest } key={ idx } status="closed" parentClickHandler={ this.parentHandleClick } />);
	    			}
	    		}.bind(this));
	    		// var databaseEntries = this.state.helpRequests.map(function(entry, idx) {
	    		// 	return <DatabaseEntry obj={ entry } key={ idx } parentClickHandler={ this.parentHandleClick } />;
	    		// }.bind(this));
	    		return (
	    			<div>
	    				<div id="oustanding" className="col-md-4">
	    					<h3 className="text-center">Outstanding</h3>
	    					{ outstandingHRs }
	    				</div>
	    				<div id="in-progress" className="col-md-4">
	    					<h3 className="text-center">In Progress</h3>
	    					{ inProgressHRs }
	    				</div>
	    				<div id="closed" className="col-md-4">
	    					<h3 className="text-center">Closed</h3>
	    					{ closedHRs }
	    				</div>
	    			</div>
    			);
	    	}
	    });

	    ReactDOM.render(
	    	<DatabaseViewer source='http://localhost:8000/data' />,
	    	document.getElementById('help-requests')
	    );

      
    </script>
  </body>
</html>
